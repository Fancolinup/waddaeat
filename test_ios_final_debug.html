<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOSäº‘å›¾ç‰‡æœ€ç»ˆè°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOSäº‘å›¾ç‰‡æœ€ç»ˆè°ƒè¯•æµ‹è¯•</h1>
        <div id="deviceInfo" class="status info">è®¾å¤‡: iOS 18.6.2 (æ¨¡æ‹Ÿç¯å¢ƒ)</div>
        
        <div class="test-section">
            <h3>æµ‹è¯•åœºæ™¯è¯´æ˜</h3>
            <p>æ¨¡æ‹ŸiOSè®¾å¤‡ä¸Šwx.cloud.getTempFileURLè¿”å›ç©ºé“¾æ¥çš„é—®é¢˜ï¼ŒéªŒè¯ä¿®å¤åçš„é€»è¾‘ï¼š</p>
            <ul>
                <li>wx.cloud.getTempFileURLæˆåŠŸè°ƒç”¨ä½†è¿”å›ç©ºçš„tempFileURL</li>
                <li>æ£€æµ‹åˆ°ç©ºé“¾æ¥åè§¦å‘é‡è¯•æœºåˆ¶</li>
                <li>é‡è¯•ä»å¤±è´¥æ—¶æ­£ç¡®å›é€€åˆ°å ä½å›¾</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•ç»“æœ</h3>
            <button onclick="runTest()">å¼€å§‹æµ‹è¯•</button>
            <div id="testResult" class="log-output"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå¾®ä¿¡å°ç¨‹åºç¯å¢ƒ
        const wx = {
            cloud: {
                getTempFileURL: function(options) {
                    console.log('ğŸ” wx.cloud.getTempFileURL è°ƒç”¨:', options);
                    
                    // æ¨¡æ‹ŸiOSè®¾å¤‡ä¸Šçš„é—®é¢˜ï¼šè¿”å›ç©ºçš„ä¸´æ—¶é“¾æ¥
                    setTimeout(() => {
                        const mockResponse = {
                            fileList: options.fileList.map(fileId => ({
                                fileID: fileId,
                                tempFileURL: '', // æ¨¡æ‹Ÿè¿”å›ç©ºé“¾æ¥
                                status: 0,
                                errCode: 0
                            }))
                        };
                        
                        console.log('ğŸ“¥ wx.cloud.getTempFileURL è¿”å›:', JSON.stringify(mockResponse));
                        if (options.success) {
                            options.success(mockResponse);
                        }
                    }, 300);
                }
            },
            getSystemInfo: function(options) {
                const mockSystemInfo = {
                    platform: 'ios',
                    system: 'iOS 18.6.2'
                };
                if (options.success) {
                    options.success(mockSystemInfo);
                }
            }
        };

        // ç®€åŒ–çš„CloudImageManageræ ¸å¿ƒé€»è¾‘
        class TestCloudImageManager {
            constructor() {
                this.isIOS = true;
                this.platform = 'ios';
                this.system = 'iOS 18.6.2';
                this.tempUrlCache = new Map();
                this.cloudBasePath = 'cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/';
                console.log('âœ… TestCloudImageManager åˆå§‹åŒ–å®Œæˆ');
            }

            async getTempHttpsUrl(imageName, extension = 'png') {
                return new Promise((resolve) => {
                    const fileId = this.cloudBasePath + imageName + '.' + extension;
                    console.log('ğŸš€ å¼€å§‹è·å–ä¸´æ—¶é“¾æ¥:', imageName, 'fileId:', fileId);
                    
                    wx.cloud.getTempFileURL({
                        fileList: [fileId],
                        success: (res) => {
                            try {
                                console.log('ğŸ“Š getTempFileURL success response:', JSON.stringify(res));
                                
                                const list = res && res.fileList ? res.fileList : [];
                                const item = list[0] || {};
                                const tempUrl = item.tempFileURL || '';
                                const status = item.status;
                                const errCode = item.errCode;
                                
                                console.log('ğŸ” è§£æç»“æœ:', {
                                    imageName,
                                    tempUrl,
                                    status,
                                    errCode,
                                    hasFileList: !!res.fileList,
                                    fileListLength: list.length
                                });
                                
                                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯çŠ¶æ€
                                if (status !== 0 || errCode) {
                                    console.warn('âš ï¸ ä¸´æ—¶é“¾æ¥è·å–æœ‰é”™è¯¯:', { status, errCode, imageName });
                                    if (this.isIOS) {
                                        console.log('ğŸ”„ iOSè®¾å¤‡æ£€æµ‹åˆ°é”™è¯¯ï¼Œå°è¯•é‡è¯•:', imageName);
                                        setTimeout(() => {
                                            this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                        }, 1000);
                                        return;
                                    } else {
                                        resolve(fileId);
                                        return;
                                    }
                                }
                                
                                if (tempUrl && tempUrl.startsWith('https://')) {
                                    this.tempUrlCache.set(fileId, tempUrl);
                                    console.log('âœ… ç”Ÿæˆä¸´æ—¶é“¾æ¥æˆåŠŸ:', imageName, '->', tempUrl);
                                    resolve(tempUrl);
                                } else {
                                    console.warn('âš ï¸ ä¸´æ—¶é“¾æ¥æ— æ•ˆæˆ–éHTTPS:', {
                                        imageName,
                                        tempUrl,
                                        tempUrlType: typeof tempUrl,
                                        tempUrlLength: tempUrl ? tempUrl.length : 0,
                                        isHttps: tempUrl ? tempUrl.startsWith('https://') : false
                                    });
                                    
                                    if (this.isIOS) {
                                        console.log('ğŸ”„ iOSè®¾å¤‡ä¸´æ—¶é“¾æ¥æ— æ•ˆï¼Œå°è¯•é‡è¯•:', imageName);
                                        setTimeout(() => {
                                            this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                        }, 1000);
                                    } else {
                                        resolve(fileId);
                                    }
                                }
                            } catch (parseErr) {
                                console.warn('âŒ è§£æä¸´æ—¶é“¾æ¥å¤±è´¥:', parseErr, 'imageName:', imageName);
                                if (this.isIOS) {
                                    setTimeout(() => {
                                        this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                    }, 1000);
                                } else {
                                    resolve(fileId);
                                }
                            }
                        },
                        fail: (error) => {
                            console.warn('âŒ è·å–ä¸´æ—¶é“¾æ¥å¤±è´¥:', error, 'imageName:', imageName);
                            if (this.isIOS) {
                                console.log('ğŸ”„ iOSè®¾å¤‡è·å–å¤±è´¥ï¼Œå°è¯•é‡è¯•:', imageName);
                                setTimeout(() => {
                                    this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                }, 1000);
                            } else {
                                resolve(fileId);
                            }
                        }
                    });
                });
            }

            retryGetTempUrl(fileId, imageName, extension, resolve) {
                console.log('ğŸ”„ å¼€å§‹é‡è¯•è·å–ä¸´æ—¶é“¾æ¥:', imageName, 'fileId:', fileId);
                
                wx.cloud.getTempFileURL({
                    fileList: [fileId],
                    success: (res) => {
                        try {
                            console.log('ğŸ“Š é‡è¯• getTempFileURL success response:', JSON.stringify(res));
                            
                            const list = res && res.fileList ? res.fileList : [];
                            const item = list[0] || {};
                            const tempUrl = item.tempFileURL || '';
                            const status = item.status;
                            const errCode = item.errCode;
                            
                            console.log('ğŸ” é‡è¯•è§£æç»“æœ:', {
                                imageName,
                                tempUrl,
                                status,
                                errCode,
                                hasFileList: !!res.fileList,
                                fileListLength: list.length
                            });
                            
                            if (status !== 0 || errCode) {
                                console.warn('âš ï¸ é‡è¯•ä»æœ‰é”™è¯¯ï¼Œä½¿ç”¨å ä½å›¾:', { status, errCode, imageName });
                                resolve('/images/placeholder.png');
                                return;
                            }
                            
                            if (tempUrl && tempUrl.startsWith('https://')) {
                                this.tempUrlCache.set(fileId, tempUrl);
                                console.log('âœ… iOSè®¾å¤‡é‡è¯•è·å–ä¸´æ—¶é“¾æ¥æˆåŠŸ:', imageName, '->', tempUrl);
                                resolve(tempUrl);
                            } else {
                                console.warn('âš ï¸ iOSè®¾å¤‡é‡è¯•ä»å¤±è´¥ï¼Œä¸´æ—¶é“¾æ¥æ— æ•ˆ:', {
                                    imageName,
                                    tempUrl,
                                    tempUrlType: typeof tempUrl,
                                    tempUrlLength: tempUrl ? tempUrl.length : 0,
                                    isHttps: tempUrl ? tempUrl.startsWith('https://') : false
                                });
                                console.log('ğŸ–¼ï¸ å›é€€åˆ°å ä½å›¾:', imageName);
                                resolve('/images/placeholder.png');
                            }
                        } catch (parseErr) {
                            console.warn('âŒ iOSè®¾å¤‡é‡è¯•è§£æå¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾:', parseErr, 'imageName:', imageName);
                            resolve('/images/placeholder.png');
                        }
                    },
                    fail: (error) => {
                        console.warn('âŒ iOSè®¾å¤‡é‡è¯•å¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾:', error, 'imageName:', imageName);
                        resolve('/images/placeholder.png');
                    }
                });
            }
        }

        // é‡å†™consoleæ–¹æ³•ä»¥æ•è·æ—¥å¿—
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToTestResult(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logElement = document.getElementById('testResult');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${
                level === 'error' ? '#d32f2f' : 
                level === 'warn' ? '#f57c00' : '#1976d2'
            };">[${level.toUpperCase()}]</span> ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToTestResult('log', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToTestResult('warn', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToTestResult('error', ...args);
        };

        // è¿è¡Œæµ‹è¯•
        async function runTest() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '';
            
            console.log('ğŸ¯ å¼€å§‹iOSäº‘å›¾ç‰‡è°ƒè¯•æµ‹è¯•');
            console.log('ğŸ“± æ¨¡æ‹Ÿè®¾å¤‡: iOS 18.6.2');
            console.log('ğŸ”§ æµ‹è¯•åœºæ™¯: wx.cloud.getTempFileURLè¿”å›ç©ºé“¾æ¥');
            
            const manager = new TestCloudImageManager();
            const testImages = ['icon_home', 'icon_voice', 'icon_profile'];
            
            console.log('ğŸ“‹ æµ‹è¯•å›¾ç‰‡åˆ—è¡¨:', testImages);
            
            for (const imageName of testImages) {
                console.log(`\nğŸ” æµ‹è¯•å›¾ç‰‡: ${imageName}`);
                try {
                    const url = await manager.getTempHttpsUrl(imageName, 'png');
                    console.log(`âœ… å›¾ç‰‡ ${imageName} æœ€ç»ˆURL:`, url);
                    
                    if (url === '/images/placeholder.png') {
                        console.log(`âœ… æ­£ç¡®å›é€€åˆ°å ä½å›¾: ${imageName}`);
                    } else if (url.startsWith('https://')) {
                        console.log(`âœ… è·å–åˆ°æœ‰æ•ˆHTTPSé“¾æ¥: ${imageName}`);
                    } else {
                        console.warn(`âš ï¸ æ„å¤–çš„URLæ ¼å¼: ${imageName} -> ${url}`);
                    }
                } catch (error) {
                    console.error(`âŒ å›¾ç‰‡ ${imageName} å¤„ç†å¼‚å¸¸:`, error);
                }
            }
            
            console.log('\nğŸ‰ æµ‹è¯•å®Œæˆï¼');
            console.log('ğŸ“Š æ€»ç»“: æ‰€æœ‰å›¾ç‰‡éƒ½åº”è¯¥æ­£ç¡®å›é€€åˆ°å ä½å›¾ /images/placeholder.png');
        }
    </script>
</body>
</html>