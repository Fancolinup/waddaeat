<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS云图片最终调试测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOS云图片最终调试测试</h1>
        <div id="deviceInfo" class="status info">设备: iOS 18.6.2 (模拟环境)</div>
        
        <div class="test-section">
            <h3>测试场景说明</h3>
            <p>模拟iOS设备上wx.cloud.getTempFileURL返回空链接的问题，验证修复后的逻辑：</p>
            <ul>
                <li>wx.cloud.getTempFileURL成功调用但返回空的tempFileURL</li>
                <li>检测到空链接后触发重试机制</li>
                <li>重试仍失败时正确回退到占位图</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>测试结果</h3>
            <button onclick="runTest()">开始测试</button>
            <div id="testResult" class="log-output"></div>
        </div>
    </div>

    <script>
        // 模拟微信小程序环境
        const wx = {
            cloud: {
                getTempFileURL: function(options) {
                    console.log('🔍 wx.cloud.getTempFileURL 调用:', options);
                    
                    // 模拟iOS设备上的问题：返回空的临时链接
                    setTimeout(() => {
                        const mockResponse = {
                            fileList: options.fileList.map(fileId => ({
                                fileID: fileId,
                                tempFileURL: '', // 模拟返回空链接
                                status: 0,
                                errCode: 0
                            }))
                        };
                        
                        console.log('📥 wx.cloud.getTempFileURL 返回:', JSON.stringify(mockResponse));
                        if (options.success) {
                            options.success(mockResponse);
                        }
                    }, 300);
                }
            },
            getSystemInfo: function(options) {
                const mockSystemInfo = {
                    platform: 'ios',
                    system: 'iOS 18.6.2'
                };
                if (options.success) {
                    options.success(mockSystemInfo);
                }
            }
        };

        // 简化的CloudImageManager核心逻辑
        class TestCloudImageManager {
            constructor() {
                this.isIOS = true;
                this.platform = 'ios';
                this.system = 'iOS 18.6.2';
                this.tempUrlCache = new Map();
                this.cloudBasePath = 'cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/';
                console.log('✅ TestCloudImageManager 初始化完成');
            }

            async getTempHttpsUrl(imageName, extension = 'png') {
                return new Promise((resolve) => {
                    const fileId = this.cloudBasePath + imageName + '.' + extension;
                    console.log('🚀 开始获取临时链接:', imageName, 'fileId:', fileId);
                    
                    wx.cloud.getTempFileURL({
                        fileList: [fileId],
                        success: (res) => {
                            try {
                                console.log('📊 getTempFileURL success response:', JSON.stringify(res));
                                
                                const list = res && res.fileList ? res.fileList : [];
                                const item = list[0] || {};
                                const tempUrl = item.tempFileURL || '';
                                const status = item.status;
                                const errCode = item.errCode;
                                
                                console.log('🔍 解析结果:', {
                                    imageName,
                                    tempUrl,
                                    status,
                                    errCode,
                                    hasFileList: !!res.fileList,
                                    fileListLength: list.length
                                });
                                
                                // 检查是否有错误状态
                                if (status !== 0 || errCode) {
                                    console.warn('⚠️ 临时链接获取有错误:', { status, errCode, imageName });
                                    if (this.isIOS) {
                                        console.log('🔄 iOS设备检测到错误，尝试重试:', imageName);
                                        setTimeout(() => {
                                            this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                        }, 1000);
                                        return;
                                    } else {
                                        resolve(fileId);
                                        return;
                                    }
                                }
                                
                                if (tempUrl && tempUrl.startsWith('https://')) {
                                    this.tempUrlCache.set(fileId, tempUrl);
                                    console.log('✅ 生成临时链接成功:', imageName, '->', tempUrl);
                                    resolve(tempUrl);
                                } else {
                                    console.warn('⚠️ 临时链接无效或非HTTPS:', {
                                        imageName,
                                        tempUrl,
                                        tempUrlType: typeof tempUrl,
                                        tempUrlLength: tempUrl ? tempUrl.length : 0,
                                        isHttps: tempUrl ? tempUrl.startsWith('https://') : false
                                    });
                                    
                                    if (this.isIOS) {
                                        console.log('🔄 iOS设备临时链接无效，尝试重试:', imageName);
                                        setTimeout(() => {
                                            this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                        }, 1000);
                                    } else {
                                        resolve(fileId);
                                    }
                                }
                            } catch (parseErr) {
                                console.warn('❌ 解析临时链接失败:', parseErr, 'imageName:', imageName);
                                if (this.isIOS) {
                                    setTimeout(() => {
                                        this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                    }, 1000);
                                } else {
                                    resolve(fileId);
                                }
                            }
                        },
                        fail: (error) => {
                            console.warn('❌ 获取临时链接失败:', error, 'imageName:', imageName);
                            if (this.isIOS) {
                                console.log('🔄 iOS设备获取失败，尝试重试:', imageName);
                                setTimeout(() => {
                                    this.retryGetTempUrl(fileId, imageName, extension, resolve);
                                }, 1000);
                            } else {
                                resolve(fileId);
                            }
                        }
                    });
                });
            }

            retryGetTempUrl(fileId, imageName, extension, resolve) {
                console.log('🔄 开始重试获取临时链接:', imageName, 'fileId:', fileId);
                
                wx.cloud.getTempFileURL({
                    fileList: [fileId],
                    success: (res) => {
                        try {
                            console.log('📊 重试 getTempFileURL success response:', JSON.stringify(res));
                            
                            const list = res && res.fileList ? res.fileList : [];
                            const item = list[0] || {};
                            const tempUrl = item.tempFileURL || '';
                            const status = item.status;
                            const errCode = item.errCode;
                            
                            console.log('🔍 重试解析结果:', {
                                imageName,
                                tempUrl,
                                status,
                                errCode,
                                hasFileList: !!res.fileList,
                                fileListLength: list.length
                            });
                            
                            if (status !== 0 || errCode) {
                                console.warn('⚠️ 重试仍有错误，使用占位图:', { status, errCode, imageName });
                                resolve('/images/placeholder.png');
                                return;
                            }
                            
                            if (tempUrl && tempUrl.startsWith('https://')) {
                                this.tempUrlCache.set(fileId, tempUrl);
                                console.log('✅ iOS设备重试获取临时链接成功:', imageName, '->', tempUrl);
                                resolve(tempUrl);
                            } else {
                                console.warn('⚠️ iOS设备重试仍失败，临时链接无效:', {
                                    imageName,
                                    tempUrl,
                                    tempUrlType: typeof tempUrl,
                                    tempUrlLength: tempUrl ? tempUrl.length : 0,
                                    isHttps: tempUrl ? tempUrl.startsWith('https://') : false
                                });
                                console.log('🖼️ 回退到占位图:', imageName);
                                resolve('/images/placeholder.png');
                            }
                        } catch (parseErr) {
                            console.warn('❌ iOS设备重试解析失败，使用占位图:', parseErr, 'imageName:', imageName);
                            resolve('/images/placeholder.png');
                        }
                    },
                    fail: (error) => {
                        console.warn('❌ iOS设备重试失败，使用占位图:', error, 'imageName:', imageName);
                        resolve('/images/placeholder.png');
                    }
                });
            }
        }

        // 重写console方法以捕获日志
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToTestResult(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logElement = document.getElementById('testResult');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${
                level === 'error' ? '#d32f2f' : 
                level === 'warn' ? '#f57c00' : '#1976d2'
            };">[${level.toUpperCase()}]</span> ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToTestResult('log', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToTestResult('warn', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToTestResult('error', ...args);
        };

        // 运行测试
        async function runTest() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '';
            
            console.log('🎯 开始iOS云图片调试测试');
            console.log('📱 模拟设备: iOS 18.6.2');
            console.log('🔧 测试场景: wx.cloud.getTempFileURL返回空链接');
            
            const manager = new TestCloudImageManager();
            const testImages = ['icon_home', 'icon_voice', 'icon_profile'];
            
            console.log('📋 测试图片列表:', testImages);
            
            for (const imageName of testImages) {
                console.log(`\n🔍 测试图片: ${imageName}`);
                try {
                    const url = await manager.getTempHttpsUrl(imageName, 'png');
                    console.log(`✅ 图片 ${imageName} 最终URL:`, url);
                    
                    if (url === '/images/placeholder.png') {
                        console.log(`✅ 正确回退到占位图: ${imageName}`);
                    } else if (url.startsWith('https://')) {
                        console.log(`✅ 获取到有效HTTPS链接: ${imageName}`);
                    } else {
                        console.warn(`⚠️ 意外的URL格式: ${imageName} -> ${url}`);
                    }
                } catch (error) {
                    console.error(`❌ 图片 ${imageName} 处理异常:`, error);
                }
            }
            
            console.log('\n🎉 测试完成！');
            console.log('📊 总结: 所有图片都应该正确回退到占位图 /images/placeholder.png');
        }
    </script>
</body>
</html>