<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS图片兼容性测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .image-item {
            text-align: center;
        }
        .image-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: border-color 0.3s;
        }
        .image-item img.loaded {
            border-color: #4CAF50;
        }
        .image-item img.error {
            border-color: #f44336;
        }
        .image-item .label {
            font-size: 12px;
            margin-top: 5px;
            word-break: break-all;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .device-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOS图片兼容性测试</h1>
        
        <div class="device-info">
            <h3>设备信息</h3>
            <div id="deviceInfo">检测中...</div>
        </div>

        <div class="test-section">
            <h3>1. 云存储fileID测试</h3>
            <p>测试云存储fileID在不同设备上的兼容性</p>
            <div class="image-grid" id="cloudFileIdGrid"></div>
            <div id="cloudFileIdStatus" class="status"></div>
        </div>

        <div class="test-section">
            <h3>2. HTTPS临时链接测试</h3>
            <p>测试通过getTempFileURL获取的HTTPS链接</p>
            <div class="image-grid" id="httpsGrid"></div>
            <div id="httpsStatus" class="status"></div>
        </div>

        <div class="test-section">
            <h3>3. 降级机制测试</h3>
            <p>测试增强的降级机制</p>
            <div class="image-grid" id="fallbackGrid"></div>
            <div id="fallbackStatus" class="status"></div>
        </div>

        <div class="test-section">
            <h3>4. 本地占位图测试</h3>
            <p>测试本地占位图的兼容性</p>
            <div class="image-grid" id="localGrid"></div>
            <div id="localStatus" class="status"></div>
        </div>

        <div class="log" id="testLog"></div>
    </div>

    <script>
        // 模拟CloudImageManager的核心功能
        class TestCloudImageManager {
            constructor() {
                this.cloudBasePath = 'cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/';
                this.isIOS = this.detectIOSDevice();
                this.log('初始化TestCloudImageManager, isIOS:', this.isIOS);
            }

            detectIOSDevice() {
                const userAgent = navigator.userAgent || '';
                const isIOS = /iPad|iPhone|iPod/.test(userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                return isIOS;
            }

            getCloudImageUrl(imageName, extension = 'png') {
                return `${this.cloudBasePath}${imageName}.${extension}`;
            }

            // 模拟微信小程序的getTempFileURL
            async getTempHttpsUrl(imageName, extension = 'png') {
                const fileId = this.getCloudImageUrl(imageName, extension);
                // 在实际环境中，这里会调用wx.cloud.getTempFileURL
                // 这里我们模拟返回一个HTTPS链接
                return `https://example-temp-url.com/${imageName}.${extension}`;
            }

            async getImageUrlWithFallback(imageName, extensions = ['png', 'jpg', 'webp']) {
                this.log(`开始降级获取图片URL: ${imageName}`);
                
                for (const ext of extensions) {
                    try {
                        let url;
                        if (this.isIOS) {
                            url = await this.getTempHttpsUrl(imageName, ext);
                            this.log(`iOS设备尝试临时链接: ${imageName}.${ext} -> ${url}`);
                        } else {
                            url = this.getCloudImageUrl(imageName, ext);
                            this.log(`非iOS设备使用云存储链接: ${imageName}.${ext} -> ${url}`);
                        }
                        
                        if (url && (url.startsWith('https://') || url.startsWith('cloud://'))) {
                            return url;
                        }
                    } catch (error) {
                        this.log(`获取图片URL失败: ${imageName}.${ext}`, error);
                        continue;
                    }
                }
                
                this.log(`所有格式都失败，使用占位图: ${imageName}`);
                if (this.isIOS) {
                    return await this.getTempHttpsUrl('placeholder', 'png');
                } else {
                    return this.getCloudImageUrl('placeholder', 'png');
                }
            }

            log(...args) {
                console.log('[TestCloudImageManager]', ...args);
                const logElement = document.getElementById('testLog');
                if (logElement) {
                    const timestamp = new Date().toLocaleTimeString();
                    logElement.innerHTML += `[${timestamp}] ${args.join(' ')}\n`;
                    logElement.scrollTop = logElement.scrollHeight;
                }
            }
        }

        // 初始化测试管理器
        const testManager = new TestCloudImageManager();

        // 显示设备信息
        function displayDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                isIOS: testManager.isIOS,
                maxTouchPoints: navigator.maxTouchPoints,
                screen: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`
            };

            document.getElementById('deviceInfo').innerHTML = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
        }

        // 创建图片测试项
        function createImageTest(container, url, label, testType) {
            const item = document.createElement('div');
            item.className = 'image-item';
            
            const img = document.createElement('img');
            img.src = url;
            img.alt = label;
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'label';
            labelDiv.textContent = label;
            
            let loadTimeout;
            
            img.onload = function() {
                clearTimeout(loadTimeout);
                img.classList.add('loaded');
                testManager.log(`✅ 图片加载成功: ${label} (${testType})`);
                updateTestStatus(testType, 'success');
            };
            
            img.onerror = function() {
                clearTimeout(loadTimeout);
                img.classList.add('error');
                testManager.log(`❌ 图片加载失败: ${label} (${testType})`);
                updateTestStatus(testType, 'error');
            };
            
            // 设置超时
            loadTimeout = setTimeout(() => {
                img.classList.add('error');
                testManager.log(`⏰ 图片加载超时: ${label} (${testType})`);
                updateTestStatus(testType, 'error');
            }, 10000);
            
            item.appendChild(img);
            item.appendChild(labelDiv);
            container.appendChild(item);
        }

        // 更新测试状态
        const testResults = {};
        function updateTestStatus(testType, result) {
            if (!testResults[testType]) {
                testResults[testType] = { success: 0, error: 0 };
            }
            testResults[testType][result]++;
            
            const statusElement = document.getElementById(`${testType}Status`);
            const { success, error } = testResults[testType];
            const total = success + error;
            
            if (success > 0 && error === 0) {
                statusElement.className = 'status success';
                statusElement.textContent = `✅ 所有图片加载成功 (${success}/${total})`;
            } else if (error > 0) {
                statusElement.className = 'status error';
                statusElement.textContent = `❌ 部分图片加载失败 (成功: ${success}, 失败: ${error})`;
            }
        }

        // 运行测试
        async function runTests() {
            displayDeviceInfo();
            
            // 测试餐厅名称列表
            const testRestaurants = ['kfc', 'mcdonald', 'pizzahut', 'starbucks', 'placeholder'];
            
            // 1. 云存储fileID测试
            const cloudFileIdGrid = document.getElementById('cloudFileIdGrid');
            testRestaurants.forEach(name => {
                const url = testManager.getCloudImageUrl(name);
                createImageTest(cloudFileIdGrid, url, `${name} (fileID)`, 'cloudFileId');
            });
            
            // 2. HTTPS临时链接测试
            const httpsGrid = document.getElementById('httpsGrid');
            for (const name of testRestaurants) {
                try {
                    const url = await testManager.getTempHttpsUrl(name);
                    createImageTest(httpsGrid, url, `${name} (HTTPS)`, 'https');
                } catch (error) {
                    testManager.log(`获取HTTPS链接失败: ${name}`, error);
                }
            }
            
            // 3. 降级机制测试
            const fallbackGrid = document.getElementById('fallbackGrid');
            for (const name of testRestaurants) {
                try {
                    const url = await testManager.getImageUrlWithFallback(name);
                    createImageTest(fallbackGrid, url, `${name} (降级)`, 'fallback');
                } catch (error) {
                    testManager.log(`降级机制失败: ${name}`, error);
                }
            }
            
            // 4. 本地占位图测试
            const localGrid = document.getElementById('localGrid');
            const localImages = [
                { url: '/images/placeholder.png', label: 'PNG占位图' },
                { url: '/images/placeholder.svg', label: 'SVG占位图' },
                { url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHJ4PSI4IiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iMzIiIHk9IjM2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiPuWNoOWbvzwvdGV4dD4KICA8L3N2Zz4=', label: 'Base64 SVG' }
            ];
            
            localImages.forEach(({ url, label }) => {
                createImageTest(localGrid, url, label, 'local');
            });
        }

        // 页面加载完成后运行测试
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>