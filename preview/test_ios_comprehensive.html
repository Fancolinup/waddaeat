<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS云图片加载综合测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #ccc;
        }
        .status-loading { background: #ffa500; }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .image-item {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        .test-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        .test-image.loading {
            border-color: #ffa500;
            opacity: 0.7;
        }
        .test-image.success {
            border-color: #4caf50;
        }
        .test-image.error {
            border-color: #f44336;
        }
        .image-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .image-url {
            font-size: 10px;
            color: #999;
            word-break: break-all;
            max-height: 40px;
            overflow: hidden;
        }
        .device-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .log-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 3px 6px;
            border-radius: 3px;
        }
        .log-info { background: #e8f5e8; color: #2e7d32; }
        .log-warn { background: #fff3e0; color: #f57c00; }
        .log-error { background: #ffebee; color: #d32f2f; }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        .test-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #1976d2;
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>iOS云图片加载综合测试</h1>
            <p>测试微信小程序云存储图片在iOS设备上的显示效果</p>
        </div>

        <div class="device-info">
            <strong>设备信息：</strong>
            <span id="deviceInfo">检测中...</span>
        </div>

        <div class="test-controls">
            <button class="test-btn" onclick="runAllTests()">开始测试</button>
            <button class="test-btn" onclick="clearLogs()">清空日志</button>
            <button class="test-btn" onclick="location.reload()">重新加载</button>
        </div>

        <!-- 测试1：基础云存储图片 -->
        <div class="test-section">
            <div class="test-title">
                <div class="status-indicator" id="status-basic"></div>
                基础云存储图片测试
            </div>
            <p>测试直接使用cloud://协议的图片加载</p>
            <div class="image-grid" id="basic-images"></div>
        </div>

        <!-- 测试2：同步方法测试 -->
        <div class="test-section">
            <div class="test-title">
                <div class="status-indicator" id="status-sync"></div>
                同步方法测试
            </div>
            <p>测试getCloudImageUrlSync方法返回的图片</p>
            <div class="image-grid" id="sync-images"></div>
        </div>

        <!-- 测试3：iOS专用异步加载测试 -->
        <div class="test-section">
            <div class="test-title">
                <div class="status-indicator" id="status-ios"></div>
                iOS专用异步加载测试
            </div>
            <p>测试loadImageForIOS方法的图片加载</p>
            <div class="image-grid" id="ios-images"></div>
        </div>

        <!-- 测试4：错误处理测试 -->
        <div class="test-section">
            <div class="test-title">
                <div class="status-indicator" id="status-error"></div>
                错误处理测试
            </div>
            <p>测试不存在的图片和占位图机制</p>
            <div class="image-grid" id="error-images"></div>
        </div>

        <div class="log-section">
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // 模拟cloudImageManager
        const mockCloudImageManager = {
            cloudBase: 'cloud://eatigo-test.6561-eatigo-test-1234567890/',
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
            
            getCloudImageUrlSync(imageName, extension = 'png') {
                if (!imageName) {
                    return `${this.cloudBase}placeholder.${extension}`;
                }
                return `${this.cloudBase}${imageName}.${extension}`;
            },
            
            async getTempHttpsUrl(imageName, extension = 'png') {
                // 模拟异步获取临时HTTPS链接
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 模拟成功获取临时链接
                        const mockUrl = `https://mock-temp-url.com/${imageName}.${extension}?temp=true`;
                        resolve(mockUrl);
                    }, Math.random() * 1000 + 500);
                });
            },
            
            loadImageForIOS(imageName, extension = 'png', onSuccess, onError) {
                if (!this.isIOS) {
                    const fileId = this.getCloudImageUrlSync(imageName, extension);
                    if (onSuccess) onSuccess(fileId);
                    return;
                }
                
                this.getTempHttpsUrl(imageName, extension)
                    .then(httpsUrl => {
                        if (onSuccess) onSuccess(httpsUrl);
                    })
                    .catch(error => {
                        console.error('iOS图片加载失败:', error);
                        const placeholderFileId = this.getCloudImageUrlSync('placeholder', extension);
                        if (onSuccess) onSuccess(placeholderFileId);
                        if (onError) onError(error);
                    });
            }
        };

        // 日志系统
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logEntry);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // 设备信息检测
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);
            const isWeChat = /MicroMessenger/.test(userAgent);
            
            let deviceType = 'Unknown';
            if (isIOS) deviceType = 'iOS';
            else if (isAndroid) deviceType = 'Android';
            else deviceType = 'Desktop/Other';
            
            const info = `${deviceType} ${isWeChat ? '(微信)' : '(浏览器)'} - ${userAgent.substring(0, 50)}...`;
            document.getElementById('deviceInfo').textContent = info;
            log(`设备检测: ${info}`);
            
            return { isIOS, isAndroid, isWeChat, deviceType };
        }

        // 创建图片测试项
        function createImageItem(imageName, url, container) {
            const item = document.createElement('div');
            item.className = 'image-item';
            
            const img = document.createElement('img');
            img.className = 'test-image loading';
            img.src = url;
            
            const label = document.createElement('div');
            label.className = 'image-label';
            label.textContent = imageName;
            
            const urlDiv = document.createElement('div');
            urlDiv.className = 'image-url';
            urlDiv.textContent = url;
            
            img.onload = () => {
                img.className = 'test-image success';
                log(`图片加载成功: ${imageName}`, 'info');
            };
            
            img.onerror = () => {
                img.className = 'test-image error';
                log(`图片加载失败: ${imageName} - ${url}`, 'error');
            };
            
            item.appendChild(img);
            item.appendChild(label);
            item.appendChild(urlDiv);
            container.appendChild(item);
            
            return img;
        }

        // 更新状态指示器
        function updateStatus(sectionId, status) {
            const indicator = document.getElementById(`status-${sectionId}`);
            indicator.className = `status-indicator status-${status}`;
        }

        // 测试1：基础云存储图片
        function testBasicCloudImages() {
            log('开始基础云存储图片测试');
            updateStatus('basic', 'loading');
            
            const container = document.getElementById('basic-images');
            container.innerHTML = '';
            
            const testImages = [
                'placeholder',
                'mcdonalds',
                'kfc',
                'starbucks',
                'nonexistent'
            ];
            
            let loadedCount = 0;
            let errorCount = 0;
            
            testImages.forEach(imageName => {
                const url = mockCloudImageManager.getCloudImageUrlSync(imageName);
                const img = createImageItem(imageName, url, container);
                
                img.onload = () => {
                    loadedCount++;
                    checkBasicTestComplete();
                };
                
                img.onerror = () => {
                    errorCount++;
                    checkBasicTestComplete();
                };
            });
            
            function checkBasicTestComplete() {
                if (loadedCount + errorCount === testImages.length) {
                    const status = errorCount === 0 ? 'success' : (loadedCount > 0 ? 'success' : 'error');
                    updateStatus('basic', status);
                    log(`基础测试完成: ${loadedCount}成功, ${errorCount}失败`);
                }
            }
        }

        // 测试2：同步方法测试
        function testSyncMethod() {
            log('开始同步方法测试');
            updateStatus('sync', 'loading');
            
            const container = document.getElementById('sync-images');
            container.innerHTML = '';
            
            const testImages = ['placeholder', 'mcdonalds', 'kfc'];
            let completedCount = 0;
            
            testImages.forEach(imageName => {
                const url = mockCloudImageManager.getCloudImageUrlSync(imageName);
                const img = createImageItem(`${imageName} (sync)`, url, container);
                
                const checkComplete = () => {
                    completedCount++;
                    if (completedCount === testImages.length) {
                        updateStatus('sync', 'success');
                        log('同步方法测试完成');
                    }
                };
                
                img.onload = checkComplete;
                img.onerror = checkComplete;
            });
        }

        // 测试3：iOS专用异步加载
        function testIOSAsyncLoading() {
            log('开始iOS专用异步加载测试');
            updateStatus('ios', 'loading');
            
            const container = document.getElementById('ios-images');
            container.innerHTML = '';
            
            const testImages = ['placeholder', 'mcdonalds', 'kfc'];
            let completedCount = 0;
            
            testImages.forEach(imageName => {
                const item = document.createElement('div');
                item.className = 'image-item';
                
                const img = document.createElement('img');
                img.className = 'test-image loading';
                
                const label = document.createElement('div');
                label.className = 'image-label';
                label.textContent = `${imageName} (iOS async)`;
                
                const urlDiv = document.createElement('div');
                urlDiv.className = 'image-url';
                urlDiv.textContent = '加载中...';
                
                item.appendChild(img);
                item.appendChild(label);
                item.appendChild(urlDiv);
                container.appendChild(item);
                
                mockCloudImageManager.loadImageForIOS(imageName, 'png', 
                    (url) => {
                        img.src = url;
                        urlDiv.textContent = url;
                        img.onload = () => {
                            img.className = 'test-image success';
                            completedCount++;
                            checkIOSTestComplete();
                        };
                        img.onerror = () => {
                            img.className = 'test-image error';
                            completedCount++;
                            checkIOSTestComplete();
                        };
                    },
                    (error) => {
                        img.className = 'test-image error';
                        urlDiv.textContent = '加载失败';
                        completedCount++;
                        checkIOSTestComplete();
                    }
                );
            });
            
            function checkIOSTestComplete() {
                if (completedCount === testImages.length) {
                    updateStatus('ios', 'success');
                    log('iOS异步加载测试完成');
                }
            }
        }

        // 测试4：错误处理
        function testErrorHandling() {
            log('开始错误处理测试');
            updateStatus('error', 'loading');
            
            const container = document.getElementById('error-images');
            container.innerHTML = '';
            
            const testCases = [
                { name: 'nonexistent1', expected: 'error' },
                { name: 'nonexistent2', expected: 'error' },
                { name: 'placeholder', expected: 'success' }
            ];
            
            let completedCount = 0;
            
            testCases.forEach(testCase => {
                mockCloudImageManager.loadImageForIOS(testCase.name, 'png',
                    (url) => {
                        const img = createImageItem(`${testCase.name} (error test)`, url, container);
                        img.onload = () => {
                            completedCount++;
                            checkErrorTestComplete();
                        };
                        img.onerror = () => {
                            completedCount++;
                            checkErrorTestComplete();
                        };
                    },
                    (error) => {
                        log(`错误处理测试: ${testCase.name} 失败 - ${error}`, 'warn');
                        completedCount++;
                        checkErrorTestComplete();
                    }
                );
            });
            
            function checkErrorTestComplete() {
                if (completedCount === testCases.length) {
                    updateStatus('error', 'success');
                    log('错误处理测试完成');
                }
            }
        }

        // 运行所有测试
        function runAllTests() {
            log('=== 开始综合测试 ===');
            clearLogs();
            
            const device = detectDevice();
            
            setTimeout(() => testBasicCloudImages(), 100);
            setTimeout(() => testSyncMethod(), 500);
            setTimeout(() => testIOSAsyncLoading(), 1000);
            setTimeout(() => testErrorHandling(), 1500);
            
            log('所有测试已启动，请观察图片加载情况');
        }

        // 页面加载完成后自动检测设备
        document.addEventListener('DOMContentLoaded', () => {
            detectDevice();
            log('页面加载完成，点击"开始测试"按钮开始测试');
        });
    </script>
</body>
</html>