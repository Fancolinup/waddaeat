<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS图片修复最终验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .image-test {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .image-test img {
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-test .label {
            font-size: 12px;
            margin-top: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOS图片加载修复最终验证</h1>
        
        <div class="test-section">
            <div class="test-title">1. 设备检测</div>
            <div id="device-info" class="test-result info">检测中...</div>
        </div>

        <div class="test-section">
            <div class="test-title">2. CloudImageManager初始化</div>
            <div id="init-result" class="test-result info">初始化中...</div>
        </div>

        <div class="test-section">
            <div class="test-title">3. 临时链接获取测试</div>
            <button onclick="testTempUrls()">测试临时链接获取</button>
            <div id="temp-url-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. 图片预加载测试</div>
            <button onclick="testPreload()">测试图片预加载</button>
            <div id="preload-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. 图片显示测试</div>
            <button onclick="testImageDisplay()">测试图片显示</button>
            <div id="image-display-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">6. 控制台日志</div>
            <button onclick="clearLog()">清空日志</button>
            <div id="console-log" class="log-area"></div>
        </div>
    </div>

    <script>
        // 模拟微信小程序环境
        const wx = {
            getSystemInfo: function(options) {
                // 模拟iOS设备
                const systemInfo = {
                    platform: 'ios',
                    system: 'iOS 18.6.2'
                };
                if (options.success) {
                    options.success(systemInfo);
                }
            },
            cloud: {
                getTempFileURL: function(options) {
                    // 模拟临时链接获取失败
                    setTimeout(() => {
                        if (options.fail) {
                            options.fail({
                                errMsg: "getTempFileURL:fail cloud function execution failed"
                            });
                        }
                    }, 100);
                }
            },
            getImageInfo: function(options) {
                const src = options.src;
                setTimeout(() => {
                    if (src === '/images/placeholder.png') {
                        if (options.success) {
                            options.success({
                                width: 100,
                                height: 100,
                                path: src
                            });
                        }
                    } else if (src.startsWith('cloud://')) {
                        if (options.fail) {
                            options.fail({
                                errMsg: "getImageInfo:fail image not found"
                            });
                        }
                    } else if (src.startsWith('https://')) {
                        if (options.success) {
                            options.success({
                                width: 100,
                                height: 100,
                                path: src
                            });
                        }
                    } else {
                        if (options.fail) {
                            options.fail({
                                errMsg: "getImageInfo:fail invalid url"
                            });
                        }
                    }
                }, 50);
            }
        };

        // 重写console.log来捕获日志
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToLog(level, ...args) {
            const logArea = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logArea.textContent += `[${timestamp}] ${level}: ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog('LOG', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('WARN', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('ERROR', ...args);
        };

        function clearLog() {
            document.getElementById('console-log').textContent = '';
        }

        // 加载CloudImageManager
        let cloudImageManager;
        
        function loadCloudImageManager() {
            return fetch('./utils/cloudImageManager.js')
                .then(response => response.text())
                .then(code => {
                    // 移除export语句，保留类定义和实例创建
                    let browserCode = code.replace(/export\s+{[^}]+};?\s*$/, '');
                    
                    // 执行代码
                    eval(browserCode);
                    
                    // 返回全局的cloudImageManager实例
                    if (typeof window.cloudImageManager !== 'undefined') {
                        return window.cloudImageManager;
                    } else if (typeof CloudImageManager !== 'undefined') {
                        return new CloudImageManager();
                    } else {
                        throw new Error('CloudImageManager未正确加载');
                    }
                });
        }

        // 初始化测试
        async function initTest() {
            try {
                // 设备检测
                const deviceInfo = document.getElementById('device-info');
                deviceInfo.innerHTML = `
                    <div>平台: iOS (模拟)</div>
                    <div>系统: iOS 18.6.2 (模拟)</div>
                    <div>isIOS: true</div>
                `;
                deviceInfo.className = 'test-result success';

                // 加载CloudImageManager
                cloudImageManager = await loadCloudImageManager();
                
                const initResult = document.getElementById('init-result');
                initResult.innerHTML = `
                    <div>CloudImageManager加载成功</div>
                    <div>iOS设备检测: ${cloudImageManager.isIOS}</div>
                    <div>云存储基础路径: ${cloudImageManager.cloudBase}</div>
                `;
                initResult.className = 'test-result success';

            } catch (error) {
                console.error('初始化失败:', error);
                const initResult = document.getElementById('init-result');
                initResult.innerHTML = `初始化失败: ${error.message}`;
                initResult.className = 'test-result error';
            }
        }

        async function testTempUrls() {
            const resultsDiv = document.getElementById('temp-url-results');
            resultsDiv.innerHTML = '<div class="test-result info">测试中...</div>';

            const testImages = ['icon_home', 'icon_voice', 'icon_profile'];
            const results = [];

            for (const imageName of testImages) {
                try {
                    console.log(`开始测试临时链接获取: ${imageName}`);
                    const url = await cloudImageManager.getTempHttpsUrl(imageName, 'png');
                    results.push({
                        name: imageName,
                        url: url,
                        success: url === '/images/placeholder.png',
                        message: url === '/images/placeholder.png' ? '正确回退到占位图' : `意外的URL: ${url}`
                    });
                } catch (error) {
                    results.push({
                        name: imageName,
                        url: null,
                        success: false,
                        message: `异常: ${error.message}`
                    });
                }
            }

            let html = '';
            results.forEach(result => {
                const className = result.success ? 'success' : 'error';
                html += `
                    <div class="test-result ${className}">
                        <strong>${result.name}</strong>: ${result.message}
                        ${result.url ? `<br>URL: ${result.url}` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        async function testPreload() {
            const resultsDiv = document.getElementById('preload-results');
            resultsDiv.innerHTML = '<div class="test-result info">测试中...</div>';

            try {
                console.log('开始测试图片预加载');
                const testImages = ['icon_home', 'icon_voice', 'icon_profile'];
                
                await cloudImageManager.preloadImages(testImages);
                
                resultsDiv.innerHTML = `
                    <div class="test-result success">
                        <strong>预加载测试完成</strong><br>
                        测试图片: ${testImages.join(', ')}<br>
                        请查看控制台日志了解详细过程
                    </div>
                `;
            } catch (error) {
                console.error('预加载测试失败:', error);
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        预加载测试失败: ${error.message}
                    </div>
                `;
            }
        }

        async function testImageDisplay() {
            const resultsDiv = document.getElementById('image-display-results');
            resultsDiv.innerHTML = '<div class="test-result info">测试中...</div>';

            const testImages = [
                { name: 'icon_home', expected: '/images/placeholder.png' },
                { name: 'icon_voice', expected: '/images/placeholder.png' },
                { name: 'placeholder', expected: '/images/placeholder.png' }
            ];

            let html = '<div class="test-result success">图片显示测试结果:</div>';
            
            for (const test of testImages) {
                try {
                    const url = cloudImageManager.getCloudImageUrl(test.name, 'png');
                    const isCorrect = url === test.expected;
                    
                    html += `
                        <div class="image-test">
                            <img src="${url}" alt="${test.name}" 
                                 onerror="this.style.border='2px solid red'" 
                                 onload="this.style.border='2px solid green'">
                            <div class="label">
                                ${test.name}<br>
                                ${isCorrect ? '✅' : '❌'} ${url}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div class="image-test">
                            <div style="width:50px;height:50px;border:2px solid red;display:flex;align-items:center;justify-content:center;">❌</div>
                            <div class="label">${test.name}<br>错误: ${error.message}</div>
                        </div>
                    `;
                }
            }

            resultsDiv.innerHTML = html;
        }

        // 页面加载时初始化
        window.addEventListener('load', initTest);
    </script>
</body>
</html>