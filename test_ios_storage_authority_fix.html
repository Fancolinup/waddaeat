<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS云存储权限错误修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .image-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .image-test img {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-info {
            flex: 1;
        }
        .image-name {
            font-weight: bold;
            color: #333;
        }
        .image-url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        .log-container {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .error { color: #ff6b6b; }
        .warn { color: #ffa500; }
        .info { color: #4ecdc4; }
        .success { color: #51cf66; }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOS云存储权限错误修复测试</h1>
        <p>测试场景：模拟STORAGE_EXCEED_AUTHORITY错误，验证修复后的降级逻辑</p>
        
        <div class="test-section">
            <h3>云存储初始化状态</h3>
            <div id="cloudStatus">
                <span class="status loading">初始化中...</span>
            </div>
        </div>

        <div class="test-section">
            <h3>图片加载测试</h3>
            <button onclick="testImageLoading()">开始测试图片加载</button>
            <div id="imageTests"></div>
        </div>

        <div class="test-section">
            <h3>调试日志</h3>
            <button onclick="clearLogs()">清空日志</button>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        // 模拟微信小程序环境
        window.wx = {
            cloud: {
                init: function(config) {
                    console.log('[Mock] wx.cloud.init called with:', config);
                    return Promise.resolve();
                },
                getTempFileURL: function(options) {
                    console.log('[Mock] wx.cloud.getTempFileURL called with:', options);
                    
                    // 模拟STORAGE_EXCEED_AUTHORITY错误
                    setTimeout(() => {
                        const fileList = options.fileList.map(fileId => ({
                            fileID: fileId,
                            tempFileURL: "", // 空的临时链接
                            maxAge: 86400,
                            status: 1, // 错误状态
                            errMsg: "STORAGE_EXCEED_AUTHORITY" // 权限错误
                        }));
                        
                        const response = {
                            errMsg: "cloud.getTempFileURL:ok",
                            fileList: fileList
                        };
                        
                        if (options.success) {
                            options.success(response);
                        }
                    }, 100);
                }
            },
            getSystemInfo: function(options) {
                // 模拟iOS设备
                const systemInfo = {
                    platform: 'ios',
                    system: 'iOS 18.6.2'
                };
                if (options.success) {
                    options.success(systemInfo);
                }
            },
            getImageInfo: function(options) {
                console.log('[Mock] wx.getImageInfo called with:', options.src);
                
                // 模拟cloud://协议图片获取失败
                if (options.src && options.src.startsWith('cloud://')) {
                    setTimeout(() => {
                        if (options.fail) {
                            options.fail({
                                errMsg: "getImageInfo:fail image not found"
                            });
                        }
                    }, 50);
                } else {
                    // 其他图片正常
                    setTimeout(() => {
                        if (options.success) {
                            options.success({
                                width: 100,
                                height: 100,
                                path: options.src
                            });
                        }
                    }, 50);
                }
            }
        };

        // 日志捕获
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 重写console方法
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            addLog(args.join(' '), 'info');
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            addLog(args.join(' '), 'warn');
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // 加载CloudImageManager
        let cloudImageManager;

        async function loadCloudImageManager() {
            try {
                // 加载cloudImageManager.js文件
                const response = await fetch('/utils/cloudImageManager.js');
                const code = await response.text();
                
                // 执行代码
                eval(code);
                
                // 获取实例
                if (window.cloudImageManager) {
                    cloudImageManager = window.cloudImageManager;
                } else if (window.CloudImageManager) {
                    cloudImageManager = new window.CloudImageManager();
                }
                
                console.log('[Test] CloudImageManager加载成功');
                document.getElementById('cloudStatus').innerHTML = '<span class="status success">已加载</span>';
                
                return true;
            } catch (error) {
                console.error('[Test] CloudImageManager加载失败:', error);
                document.getElementById('cloudStatus').innerHTML = '<span class="status error">加载失败</span>';
                return false;
            }
        }

        // 测试图片加载
        async function testImageLoading() {
            if (!cloudImageManager) {
                console.error('[Test] CloudImageManager未加载');
                return;
            }

            const testImages = [
                'icon_home',
                'icon_home_selected',
                'icon_voice',
                'icon_voice_selected',
                'icon_profile',
                'icon_profile_selected'
            ];

            const imageTestsContainer = document.getElementById('imageTests');
            imageTestsContainer.innerHTML = '';

            console.log('[Test] 开始测试图片加载，预期所有图片都会因为STORAGE_EXCEED_AUTHORITY错误而使用占位图');

            for (const imageName of testImages) {
                const imageTest = document.createElement('div');
                imageTest.className = 'image-test';
                imageTest.innerHTML = `
                    <img id="img-${imageName}" src="" alt="${imageName}" style="display:none;">
                    <div class="image-info">
                        <div class="image-name">${imageName}</div>
                        <div class="image-url" id="url-${imageName}">加载中...</div>
                    </div>
                `;
                imageTestsContainer.appendChild(imageTest);

                // 测试图片加载
                try {
                    console.log(`[Test] 开始测试图片: ${imageName}`);
                    const url = await cloudImageManager.getTempHttpsUrl(imageName, 'png');
                    
                    const imgElement = document.getElementById(`img-${imageName}`);
                    const urlElement = document.getElementById(`url-${imageName}`);
                    
                    imgElement.src = url;
                    imgElement.style.display = 'block';
                    urlElement.textContent = url;
                    
                    // 验证是否使用了占位图
                    if (url === '/images/placeholder.png') {
                        console.log(`[Test] ✅ ${imageName} 正确使用占位图`);
                        urlElement.style.color = '#51cf66';
                    } else {
                        console.warn(`[Test] ⚠️ ${imageName} 未使用占位图: ${url}`);
                        urlElement.style.color = '#ffa500';
                    }
                } catch (error) {
                    console.error(`[Test] ❌ ${imageName} 加载失败:`, error);
                    document.getElementById(`url-${imageName}`).textContent = `错误: ${error.message}`;
                    document.getElementById(`url-${imageName}`).style.color = '#ff6b6b';
                }
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // 页面加载完成后初始化
        window.addEventListener('load', async () => {
            console.log('[Test] 页面加载完成，开始初始化');
            
            // 初始化云存储
            await wx.cloud.init({
                env: 'cloud1-4gw154ajfc4d5163'
            });
            
            // 加载CloudImageManager
            await loadCloudImageManager();
            
            console.log('[Test] 初始化完成，可以开始测试');
        });
    </script>
</body>
</html>