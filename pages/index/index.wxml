<view class="container" bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd">
  <view class="disabled-banner banner-location">
    <image class="icon" src="/images/map.svg" mode="widthFix" />
    <text class="msg">定位功能</text>
    <text class="dev-tag">开发中</text>
  </view>
  <view class="title">What's today's feast?</view>

  <!-- 轮盘容器：指针向下，轮盘本身旋转，按钮保持固定 -->
  <view class="hero-area">
    <view class="roulette-wheel-container">
      <view class="roulette-wheel palette-{{currentPaletteKey}} {{spinClass}}" style="transform: rotate({{rouletteRotation}}deg);">
        <block wx:for="{{segments}}" wx:for-index="sidx" wx:key="sidx">
           <view class="roulette-item" style="transform: rotate({{item.angle}}deg)">
             <!-- 扇区内径向排版文本：从外向内排列 -->
             <view class="label-clip">
               <block wx:for="{{item.chars}}" wx:for-index="cidx" wx:for-item="ch" wx:key="*this">
                 <text class="label-ch" style="transform: translate(-50%, -50%) translateY(-{{ ch.pos }}rpx);">{{ch.ch}}</text>
               </block>
             </view>
           </view>
         </block>
       </view>
  
      <!-- 指针（顶部，三角形朝下指向中心） -->
      <view class="pointer"></view>
  
      <!-- 右下角操作按钮：配色切换 + 刷新推荐（仅改变纵坐标） -->
      <view class="top-actions">
        <view class="palette-switch" bindtap="onTogglePalette">
          <view class="palette-wheel"></view>
        </view>
      </view>
  
      <!-- 固定在中心的开始按钮与手型（手型独立覆盖，不影响按钮尺寸） -->
      <view class="roulette-center">
        <image class="start-hand" src="/images/hand.png" mode="widthFix" />
        <view class="start-button" bindtap="spinRoulette"><text class="art-text">开始</text></view>
      </view>

      <!-- 轮盘右下角扩展操作：添加更多餐厅（相对轮盘容器绝对定位） -->
      <view wx:if="{{wheelType === 'restaurant'}}" class="roulette-extra-actions">
        <button class="add-restaurant-btn" bindtap="onAddMoreRestaurants">添加餐厅</button>
      </view>
    </view>
  </view>

  <!-- 顶部toast提示 -->
  <view class="top-toast" hidden="{{!showTopToast}}">{{topToastText}}</view>

  <!-- 决策浮层 -->
  <view class="decision-layer" hidden="{{!showDecisionLayer}}">
    <view class="dl-body">
      <!-- 根据转盘类型切换logo呈现方式：餐厅/茶饮/外卖统一使用云端图片 -->
      <image class="dl-logo" src="{{selected ? selected.icon : placeholderImageUrl}}" mode="aspectFill" binderror="onSelectedLogoError" />
      <view class="dl-info">
        <view class="dl-name">{{selected && selected.name}}</view>
        <view class="dl-type" wx:if="{{wheelType !== 'beverage'}}">{{selected && (selected.type || '餐厅')}}</view>
        <view class="dl-promo">{{selected && (selected.promoText || '优惠信息：敬请期待')}}</view>
        
        <!-- 外卖品牌列表 -->
        <!-- 外卖品牌列表 -->
        <!-- 外卖品牌列表已移至结果浮层底部展示位置（见下方） -->
        
        <!-- 茶饮类型标签 -->
        <view class="dl-beverage-info" wx:if="{{wheelType === 'beverage' && selected}}">
          <view class="beverage-type-tag beverage-type-{{selected.typeClass}}">{{selected.type}}</view>
          <view class="beverage-tags" wx:if="{{selected.tags && selected.tags.length}}">
            <text class="tag-item" wx:for="{{selected.tags}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
      </view>
    </view>
    <!-- 外卖品牌列表：置于结果浮层底部（按钮上方） -->
    <view class="dl-brands" wx:if="{{wheelType === 'takeout' && selected && selected.brands}}">
      <view class="brands-title">推荐品牌：</view>
      <view class="brands-list">
        <view class="brand-item" wx:for="{{selected.brands}}" wx:key="brand_name">
          {{item.brand_name}}
        </view>
      </view>
    </view>
    <view class="dl-actions">
      <button class="dl-btn dl-primary" bindtap="onAccept">就它</button>
      <button class="dl-btn dl-secondary" bindtap="onReroll">再转一次</button>
      <button class="dl-btn dl-secondary" bindtap="onAddShortlist">加入备选</button>
    </view>
  </view>

  <!-- 转盘切换按钮区域容器：提供固定占位，避免与其他元素相互影响 -->
  <view class="wheel-type-switcher-area">
    <view class="wheel-type-switcher ws-{{wheelType}} {{switchingAnimation ? 'switching' : ''}}">
      <view class="switcher-item item-restaurant {{wheelType === 'restaurant' ? 'active' : ''}}" data-type="restaurant" bindtap="onSwitchWheelType">
        <image class="icon" src="cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/canteen.png" mode="aspectFit"></image>
        <text class="switcher-text">堂食</text>
      </view>
      <view class="switcher-item item-takeout {{wheelType === 'takeout' ? 'active' : ''}}" data-type="takeout" bindtap="onSwitchWheelType">
        <image class="icon" src="cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/takeout.png" mode="aspectFit"></image>
        <text class="switcher-text">外卖</text>
      </view>
      <view class="switcher-item item-beverage {{wheelType === 'beverage' ? 'active' : ''}}" data-type="beverage" bindtap="onSwitchWheelType">
        <image class="icon" src="cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/beverage.png" mode="aspectFit"></image>
        <text class="switcher-text">奶茶咖啡</text>
      </view>
    </view>
  </view>



  <!-- 备选区（3个透明背景虚线占位，填充后显示logo卡片+删除按钮） -->
  <view class="shortlist">
    <view class="short-title">备选清单</view>
    <view class="short-grid short-grid-3">
      <block wx:for="{{shortlist}}" wx:key="id">
        <view class="short-slot filled {{activeShortlistId === item.id ? 'selected' : ''}}" data-id="{{item.id}}" data-name="{{item.name}}" bindtap="onTapShortlistCard">
          <image class="short-img" src="{{item.icon}}" mode="scaleToFill" />
          <text class="short-remove" data-id="{{item.id}}" catchtap="onRemoveShort">×</text>
        </view>
      </block>
      <block wx:for="{{placeholderSlots}}" wx:key="*this">
        <view class="short-slot placeholder"></view>
      </block>
    </view>
  </view>

  <!-- 分享区（固定底部条，图标按钮在右侧，3rpx 边距） -->
  <view class="share-bar">
    <view class="share-content">
      <text class="share-title">转发好友，一起决策</text>
      <text class="share-text">{{shareText}}</text>
    </view>
    <view class="share-actions">
       <image class="icon-btn" src="/images/copy.svg" catchtap="onCopyShare" />
       <image class="icon-btn" src="/images/refresh.svg" catchtap="onRefreshShare" />
       <!-- 移除：旧的定位开发中提示 -->
     </view>
  </view>
  <view class="page-bottom-spacer"></view>
  <!-- 隐藏离屏画布：用于回退绘制分享图片 -->
  <canvas class="offscreen-canvas" canvas-id="shareCanvas" type="2d"></canvas>
  <!-- XR-FRAME 场景：隐藏，仅用于截图与分享系统 -->
  <xr-scene id="xr-scene" class="xr-hidden" ar-system bind:ready="onXrReady"></xr-scene>
</view>