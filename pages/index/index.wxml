<view class="container" bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd">
  <view class="banner-location {{locationStatus === 'loading' ? 'loading' : ''}}" bindtap="onLocationTap">
    <image class="icon" src="/images/map.svg" mode="widthFix" />
    <text class="msg">{{locationText}}</text>
    <text wx:if="{{locationStatus === 'loading'}}" class="loading-dot">...</text>
  </view>


  <!-- 轮盘容器：指针向下，轮盘本身旋转，按钮保持固定 -->
  <view class="hero-area" style="transform: {{wheelTransform}};">
    <view class="roulette-wheel-container">
      <view class="roulette-wheel palette-{{currentPaletteKey}} wt-{{wheelType}} {{spinClass}}" style="transform: rotate({{rouletteRotation}}deg); transition: transform {{spinDurationMs}}ms cubic-bezier(.24,.8,.26,1);">
        <block wx:for="{{segments}}" wx:for-index="sidx" wx:key="sidx">
           <view class="roulette-item" style="transform: rotate({{item.angle}}deg)">
             <!-- 扇区内径向排版文本：从外向内排列 -->
             <view class="label-clip">
               <block wx:for="{{item.chars}}" wx:for-index="cidx" wx:for-item="ch" wx:key="*this">
                 <text class="label-ch" style="transform: translate(-50%, -50%) translateY(-{{ ch.pos }}rpx);">{{ch.ch}}</text>
               </block>
             </view>
           </view>
         </block>
       </view>
  
      <!-- 指针（顶部，三角形朝下指向中心） -->
      <view class="pointer"></view>
  
      <!-- 右下角操作按钮：配色切换 + 刷新推荐（仅改变纵坐标） -->
      <view class="top-actions" style="transform: {{paletteTransform}};">
        <view class="palette-switch" bindtap="onTogglePalette">
    <view class="palette-wheel palette-{{currentPaletteKey}} wt-{{wheelType}}"></view>
  </view>
      </view>
  
      <!-- 固定在中心的开始按钮与手型（手型独立覆盖，不影响按钮尺寸） -->
      <view class="roulette-center">
        <image class="start-hand" src="/images/hand.png" mode="widthFix" />
        <view class="start-button" bindtap="spinRoulette"><text class="art-text">开始</text></view>
      </view>

      <!-- 轮盘右下角扩展操作：添加更多餐厅（相对轮盘容器绝对定位） -->
      <view wx:if="{{wheelType === 'restaurant' && !(nearbyRestaurants && nearbyRestaurants.length > 0)}}" class="roulette-extra-actions" style="transform: {{addBtnTransform}};">
        <button class="add-restaurant-btn" bindtap="onAddMoreRestaurants">添加餐厅</button>
      </view>
    </view>
  </view>

  <!-- 顶部toast提示 -->
  <view class="top-toast" hidden="{{!showTopToast}}">{{topToastText}}</view>

  <!-- 毛玻璃遮罩层 -->
  <view class="glass-overlay" hidden="{{!showDecisionLayer}}" bindtap="onOverlayTap"></view>

  <!-- 决策浮层 -->
  <view class="decision-layer" hidden="{{!showDecisionLayer}}">
    <scroll-view class="dl-content" scroll-y="true">
      <view class="dl-body">
        <!-- 根据转盘类型切换logo呈现方式：餐厅/茶饮/外卖统一使用云端图片 -->
        <image class="dl-logo" src="{{selected ? selected.icon : placeholderImageUrl}}" mode="aspectFill" binderror="onSelectedLogoError" lazy-load="true" />
        <view class="dl-info">
          <view class="dl-name">{{selected && selected.name}}</view>
          <view class="dl-type" wx:if="{{wheelType !== 'beverage'}}">{{selected && (selected.type || '餐厅')}}</view>
          <view class="dl-meta" wx:if="{{wheelType !== 'beverage'}}">
            <text class="dl-rating" wx:if="{{selected && selected.ratingDisplay}}">{{selected.ratingDisplay}}</text>
            <text class="dl-sep" wx:if="{{selected && selected.ratingDisplay && selected.costDisplay}}">·</text>
            <text class="dl-cost" wx:if="{{selected && selected.costDisplay}}">人均 {{selected.costDisplay}}</text>
          </view>
          <view class="dl-promo">{{selected && (selected.promoText || '优惠信息：敬请期待')}}</view>
          <view class="beverage-tags" wx:if="{{wheelType !== 'beverage' && selected && selected.tags && selected.tags.length}}">
            <text class="tag-item" wx:for="{{selected.tags}}" wx:key="*this">{{item}}</text>
          </view>
          
          <!-- 外卖品牌列表 -->
          <!-- 外卖品牌列表 -->
          <!-- 外卖品牌列表已移至结果浮层底部展示位置（见下方） -->
          
          <!-- 茶饮类型标签 -->
          <view class="dl-beverage-info" wx:if="{{wheelType === 'beverage' && selected}}">
            <view class="beverage-type-tag beverage-type-{{selected.typeClass}}">{{selected.type}}</view>
            <view class="beverage-tags" wx:if="{{selected.tags && selected.tags.length}}">
              <text class="tag-item" wx:for="{{selected.tags}}" wx:key="*this">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
      <!-- 外卖品牌列表：置于结果浮层底部（按钮上方） -->
      <view class="dl-brands" wx:if="{{wheelType === 'takeout' && selected && selected.brands}}">
        <view class="brands-title">推荐品牌：</view>
        <view class="brands-list">
          <view class="brand-item" wx:for="{{selected.brands}}" wx:key="brand_name">
            {{item.brand_name}}
          </view>
        </view>
      </view>
    </scroll-view>


    <!-- 导航按钮：图片直接作为按钮 -->
    <view class="dl-navigation" wx:if="{{selected && selected.isFromAmap}}">
      <image class="nav-icon-button" src="cloud://cloud1-4gw154ajfc4d5163.636c-cloud1-4gw154ajfc4d5163-1379600796/FullRest/mapdirection.png" bindtap="onNavigateToRestaurant" mode="aspectFill"></image>
      <text class="nav-text" bindtap="onNavigateToRestaurant">导航去这里</text>
    </view>

    <view class="dl-actions">
      <button class="dl-btn dl-primary" bindtap="onAccept">就它，帮我领券</button>
      <button class="dl-btn dl-secondary" bindtap="onReroll">再转一次</button>
      <button class="dl-btn dl-tertiary" bindtap="onAddShortlist">加入备选</button>
    </view>
  </view>

  <!-- 转盘切换按钮区域容器：提供固定占位，避免与其他元素相互影响 -->
  <view class="wheel-type-switcher-area" style="transform: {{switcherTransform}};">
    <view class="wheel-type-switcher ws-{{wheelType}} {{switchingAnimation ? 'switching' : ''}}">
      <view class="switcher-item item-restaurant {{wheelType === 'restaurant' ? 'active' : ''}}" data-type="restaurant" bindtap="onSwitchWheelType">
        <image class="icon" src="{{switchIcons.canteen || placeholderImageUrl}}" mode="aspectFit"></image>
        <text class="switcher-text">堂食</text>
      </view>
      <view class="switcher-item item-takeout {{wheelType === 'takeout' ? 'active' : ''}}" data-type="takeout" bindtap="onSwitchWheelType">
        <image class="icon" src="{{switchIcons.takeout || placeholderImageUrl}}" mode="aspectFit"></image>
        <text class="switcher-text">外卖</text>
      </view>
      <view class="switcher-item item-beverage {{wheelType === 'beverage' ? 'active' : ''}}" data-type="beverage" bindtap="onSwitchWheelType">
        <image class="icon" src="{{switchIcons.beverage || placeholderImageUrl}}" mode="aspectFit"></image>
        <text class="switcher-text">奶茶咖啡</text>
      </view>
    </view>
  </view>



  <!-- 备选与分享：左右并排布局 -->
  <view class="short-share-row">
    <view class="shortlist compact" style="transform: {{shortlistTransform}};">
      <view class="short-title">备选清单</view>
      <view class="short-grid short-grid-3 compact">
        <block wx:for="{{shortlist}}" wx:key="index" wx:for-index="idx">
          <view class="short-slot filled {{activeShortlistIndex === idx ? 'selected' : ''}}" data-id="{{item.id}}" data-name="{{item.name}}" data-idx="{{idx}}" bindtap="onTapShortlistCard">
            <image class="short-img" src="{{item.icon}}" mode="scaleToFill" lazy-load="true" data-id="{{item.id}}" binderror="onShortImgError" />
            <view class="short-caption">{{item.name}}</view>
            <view class="short-confirm" wx:if="{{activeShortlistIndex === idx}}" data-id="{{item.id}}" data-name="{{item.name}}" data-idx="{{idx}}" catchtap="onShortConfirm">就它<text wx:if="{{wheelType === 'takeout' || wheelType === 'beverage'}}">(去下单)</text></view>
            <text class="short-remove" data-id="{{item.id}}" catchtap="onRemoveShort">×</text>
          </view>
        </block>
        <block wx:for="{{placeholderSlots}}" wx:key="*this">
          <view class="short-slot placeholder"></view>
        </block>
      </view>
    </view>
    <view class="share-panel" style="transform: {{shareTransform}};">
      <view class="share-title">转发好友，一起决策</view>
      <view class="share-text">{{shareText}}</view>
      <view class="share-actions">
        <image class="icon-btn" src="/images/copy.svg" catchtap="onCopyShare" />
        <image class="icon-btn" src="/images/refresh.svg" catchtap="onRefreshShare" />
      </view>
    </view>
  </view>

  <!-- 底部预留空间：迁移“附近优惠”模块 -->
  <view class="nearby-section" style="transform: {{nearbyTransform}};">
    <view class="nearby-header">
      <text class="nearby-title">附近优惠</text>
      <!-- 不重复位置选择模块：今日选择页顶部已有位置选择按钮 -->
    </view>

    <!-- 未获取到位置或经纬度无效时的提示占位 -->
    <view wx:if="{{!userLocation || !userLocation.latitude || !userLocation.longitude}}" class="nearby-placeholder">左上角定位后展示附近优惠</view>

    <!-- 加载中提示：在已定位但附近优惠加载中时展示 -->
    <view wx:elif="{{nearbyLoading}}" class="nearby-loading">附近优惠加载中<text class="dot dot1">.</text><text class="dot dot2">.</text><text class="dot dot3">.</text></view>

    <!-- 当已定位但暂无附近优惠时，给出提示占位 -->
    <view wx:elif="{{!(nearbyOffers && nearbyOffers.length > 0)}}" class="nearby-placeholder">附近暂无优惠</view>

    <!-- 展示餐厅横滑列表（logo作底图+餐厅名），数据来自今日选择页的 nearbyOffers -->
    <scroll-view wx:else class="horizontal-list" scroll-x="true" enable-flex="true">
      <view class="h-card" wx:for="{{nearbyOffers}}" wx:key="id" data-id="{{item.id}}" bindtap="onNearbyRestaurantTap">
        <image class="h-bg" src="{{item.logoUrl || '/images/placeholder.png'}}" mode="aspectFill" />
        <view class="h-overlay">
          <view class="h-title">{{item.name}}</view>
          <view wx:if="{{item.distance}}" class="h-sub">{{item.distance}}m</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <view class="page-bottom-spacer"></view>
  <!-- 隐藏离屏画布：用于回退绘制分享图片 -->
  <canvas class="offscreen-canvas" canvas-id="shareCanvas" type="2d"></canvas>
  <!-- XR-FRAME 场景：隐藏，仅用于截图与分享系统 -->
  <xr-scene id="xr-scene" class="xr-hidden" ar-system bind:ready="onXrReady"></xr-scene>
</view>