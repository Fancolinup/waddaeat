<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOSå›¾ç‰‡åŠ è½½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin: 10px;
            border: 2px solid #ddd;
            object-fit: cover;
        }
        .image-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .device-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>iOSå›¾ç‰‡åŠ è½½ä¿®å¤æµ‹è¯•</h1>
        
        <div class="device-info" id="deviceInfo">
            <h3>è®¾å¤‡ä¿¡æ¯</h3>
            <p>æ­£åœ¨æ£€æµ‹è®¾å¤‡ä¿¡æ¯...</p>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•1: äº‘ç«¯å›¾ç‰‡åŠ è½½ (ä¿®å¤å)</h3>
            <p>æµ‹è¯•ä¿®å¤åçš„äº‘ç«¯å›¾ç‰‡åŠ è½½æœºåˆ¶ï¼ŒiOSè®¾å¤‡åº”è¯¥è‡ªåŠ¨ä½¿ç”¨HTTPSä¸´æ—¶é“¾æ¥</p>
            <div class="image-grid" id="cloudImages"></div>
            <div class="log" id="cloudLog"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•2: å ä½å›¾åŠ è½½</h3>
            <p>æµ‹è¯•å ä½å›¾åœ¨å„ç§æƒ…å†µä¸‹çš„æ˜¾ç¤º</p>
            <div class="image-grid" id="placeholderImages"></div>
            <div class="log" id="placeholderLog"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•3: é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶</h3>
            <p>æµ‹è¯•å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„é™çº§å¤„ç†</p>
            <div class="image-grid" id="errorImages"></div>
            <div class="log" id="errorLog"></div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="mainLog"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸCloudImageManageræ ¸å¿ƒåŠŸèƒ½
        class TestCloudImageManager {
            constructor() {
                this.isIOS = this.detectIOSDevice();
                this.cache = new Map();
                this.log('CloudImageManageråˆå§‹åŒ–', `iOSè®¾å¤‡: ${this.isIOS}`);
            }

            detectIOSDevice() {
                const ua = navigator.userAgent;
                return /iPhone|iPad|iPod/i.test(ua) || 
                       (/Macintosh/i.test(ua) && 'ontouchend' in document);
            }

            log(action, message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${action}: ${message}`;
                console.log(logMessage);
                
                const mainLog = document.getElementById('mainLog');
                if (mainLog) {
                    mainLog.innerHTML += logMessage + '\n';
                    mainLog.scrollTop = mainLog.scrollHeight;
                }
            }

            // æ¨¡æ‹ŸåŒæ­¥ç‰ˆæœ¬
            getCloudImageUrlSync(imageName, ext = 'png') {
                if (!imageName || imageName === 'placeholder') {
                    return `cloud://test-env.7465-test-env/images/placeholder.${ext}`;
                }
                return `cloud://test-env.7465-test-env/images/${imageName}.${ext}`;
            }

            // æ¨¡æ‹Ÿå¼‚æ­¥ç‰ˆæœ¬ (iOSè®¾å¤‡ä¼šè°ƒç”¨getTempHttpsUrl)
            async getCloudImageUrl(imageName, ext = 'png') {
                if (!imageName || imageName === 'placeholder') {
                    if (this.isIOS) {
                        this.log('iOSå ä½å›¾', 'ä½¿ç”¨HTTPSä¸´æ—¶é“¾æ¥');
                        return await this.getTempHttpsUrl('placeholder', ext);
                    }
                    return this.getCloudImageUrlSync(imageName, ext);
                }

                if (this.isIOS) {
                    this.log('iOSäº‘å›¾ç‰‡', `è·å–${imageName}çš„HTTPSä¸´æ—¶é“¾æ¥`);
                    return await this.getTempHttpsUrl(imageName, ext);
                }
                
                return this.getCloudImageUrlSync(imageName, ext);
            }

            // æ¨¡æ‹Ÿè·å–HTTPSä¸´æ—¶é“¾æ¥
            async getTempHttpsUrl(imageName, ext = 'png') {
                const cacheKey = `${imageName}.${ext}`;
                
                if (this.cache.has(cacheKey)) {
                    this.log('ç¼“å­˜å‘½ä¸­', `ä½¿ç”¨ç¼“å­˜çš„${cacheKey}`);
                    return this.cache.get(cacheKey);
                }

                try {
                    // æ¨¡æ‹Ÿå¾®ä¿¡äº‘å­˜å‚¨APIè°ƒç”¨
                    await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 200));
                    
                    // æ¨¡æ‹ŸæˆåŠŸè·å–HTTPSé“¾æ¥
                    const httpsUrl = `https://7465-test-env-1234567890.tcb.qcloud.la/images/${imageName}.${ext}?sign=abcd1234&t=1234567890`;
                    
                    this.cache.set(cacheKey, httpsUrl);
                    this.log('HTTPSé“¾æ¥è·å–æˆåŠŸ', `${imageName}.${ext} -> ${httpsUrl.substring(0, 50)}...`);
                    
                    return httpsUrl;
                } catch (error) {
                    this.log('HTTPSé“¾æ¥è·å–å¤±è´¥', `${imageName}.${ext}: ${error.message}`);
                    // è¿”å›åŸå§‹fileIDä½œä¸ºå…œåº•
                    return `cloud://test-env.7465-test-env/images/${imageName}.${ext}`;
                }
            }

            // æ¨¡æ‹Ÿå¢å¼ºé™çº§æœºåˆ¶
            async getImageUrlWithFallback(imageName, preferredExt = 'png') {
                const extensions = ['png', 'jpg', 'webp'];
                const startIdx = extensions.indexOf(preferredExt);
                const orderedExts = startIdx >= 0 
                    ? [preferredExt, ...extensions.filter(e => e !== preferredExt)]
                    : extensions;

                for (const ext of orderedExts) {
                    try {
                        const url = await this.getCloudImageUrl(imageName, ext);
                        if (url && !url.startsWith('cloud://')) {
                            this.log('é™çº§æˆåŠŸ', `${imageName}.${ext} è·å–åˆ°æœ‰æ•ˆURL`);
                            return url;
                        }
                    } catch (error) {
                        this.log('é™çº§å°è¯•å¤±è´¥', `${imageName}.${ext}: ${error.message}`);
                    }
                }

                // æœ€ç»ˆå…œåº•
                this.log('é™çº§å…œåº•', `ä½¿ç”¨å ä½å›¾æ›¿ä»£${imageName}`);
                return await this.getCloudImageUrl('placeholder', 'png');
            }
        }

        // åˆå§‹åŒ–æµ‹è¯•
        const cloudImageManager = new TestCloudImageManager();

        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function showDeviceInfo() {
            const deviceInfo = document.getElementById('deviceInfo');
            const ua = navigator.userAgent;
            const isIOS = cloudImageManager.isIOS;
            
            deviceInfo.innerHTML = `
                <h3>è®¾å¤‡ä¿¡æ¯</h3>
                <p><strong>User Agent:</strong> ${ua}</p>
                <p><strong>æ£€æµ‹ç»“æœ:</strong> ${isIOS ? 'iOSè®¾å¤‡' : 'éiOSè®¾å¤‡'}</p>
                <p><strong>æµ‹è¯•æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
            `;
        }

        // åˆ›å»ºæµ‹è¯•å›¾ç‰‡å…ƒç´ 
        function createTestImage(src, alt, onLoad, onError) {
            const img = document.createElement('img');
            img.className = 'test-image';
            img.alt = alt;
            img.title = alt;
            
            const container = document.createElement('div');
            container.style.textAlign = 'center';
            container.style.margin = '10px';
            
            const label = document.createElement('div');
            label.style.fontSize = '12px';
            label.style.marginTop = '5px';
            label.textContent = alt;
            
            const status = document.createElement('span');
            status.className = 'status info';
            status.textContent = 'åŠ è½½ä¸­...';
            
            img.onload = () => {
                status.className = 'status success';
                status.textContent = 'æˆåŠŸ';
                if (onLoad) onLoad();
            };
            
            img.onerror = () => {
                status.className = 'status error';
                status.textContent = 'å¤±è´¥';
                if (onError) onError();
            };
            
            img.src = src;
            
            container.appendChild(img);
            container.appendChild(label);
            container.appendChild(status);
            
            return container;
        }

        // æµ‹è¯•1: äº‘ç«¯å›¾ç‰‡åŠ è½½
        async function testCloudImages() {
            const container = document.getElementById('cloudImages');
            const log = document.getElementById('cloudLog');
            
            const testImages = ['kendeji', 'maidanglao', 'haidilao', 'xingbake'];
            
            for (const imageName of testImages) {
                try {
                    const url = await cloudImageManager.getCloudImageUrl(imageName, 'png');
                    const imgElement = createTestImage(
                        url, 
                        imageName,
                        () => log.innerHTML += `âœ… ${imageName}: åŠ è½½æˆåŠŸ\n`,
                        () => log.innerHTML += `âŒ ${imageName}: åŠ è½½å¤±è´¥\n`
                    );
                    container.appendChild(imgElement);
                    
                    log.innerHTML += `ğŸ”— ${imageName}: ${url.substring(0, 60)}...\n`;
                } catch (error) {
                    log.innerHTML += `âŒ ${imageName}: è·å–URLå¤±è´¥ - ${error.message}\n`;
                }
            }
        }

        // æµ‹è¯•2: å ä½å›¾åŠ è½½
        async function testPlaceholderImages() {
            const container = document.getElementById('placeholderImages');
            const log = document.getElementById('placeholderLog');
            
            try {
                // æµ‹è¯•åŒæ­¥ç‰ˆæœ¬
                const syncUrl = cloudImageManager.getCloudImageUrlSync('placeholder', 'png');
                const syncImg = createTestImage(
                    syncUrl,
                    'åŒæ­¥å ä½å›¾',
                    () => log.innerHTML += `âœ… åŒæ­¥å ä½å›¾: åŠ è½½æˆåŠŸ\n`,
                    () => log.innerHTML += `âŒ åŒæ­¥å ä½å›¾: åŠ è½½å¤±è´¥\n`
                );
                container.appendChild(syncImg);
                log.innerHTML += `ğŸ”— åŒæ­¥å ä½å›¾: ${syncUrl}\n`;

                // æµ‹è¯•å¼‚æ­¥ç‰ˆæœ¬
                const asyncUrl = await cloudImageManager.getCloudImageUrl('placeholder', 'png');
                const asyncImg = createTestImage(
                    asyncUrl,
                    'å¼‚æ­¥å ä½å›¾',
                    () => log.innerHTML += `âœ… å¼‚æ­¥å ä½å›¾: åŠ è½½æˆåŠŸ\n`,
                    () => log.innerHTML += `âŒ å¼‚æ­¥å ä½å›¾: åŠ è½½å¤±è´¥\n`
                );
                container.appendChild(asyncImg);
                log.innerHTML += `ğŸ”— å¼‚æ­¥å ä½å›¾: ${asyncUrl.substring(0, 60)}...\n`;
                
            } catch (error) {
                log.innerHTML += `âŒ å ä½å›¾æµ‹è¯•å¤±è´¥: ${error.message}\n`;
            }
        }

        // æµ‹è¯•3: é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
        async function testErrorHandling() {
            const container = document.getElementById('errorImages');
            const log = document.getElementById('errorLog');
            
            // æµ‹è¯•ä¸å­˜åœ¨çš„å›¾ç‰‡
            const nonExistentImages = ['nonexistent1', 'nonexistent2'];
            
            for (const imageName of nonExistentImages) {
                try {
                    const url = await cloudImageManager.getImageUrlWithFallback(imageName, 'png');
                    const imgElement = createTestImage(
                        url,
                        `é™çº§æµ‹è¯•: ${imageName}`,
                        () => log.innerHTML += `âœ… ${imageName}: é™çº§æˆåŠŸ\n`,
                        () => log.innerHTML += `âŒ ${imageName}: é™çº§å¤±è´¥\n`
                    );
                    container.appendChild(imgElement);
                    
                    log.innerHTML += `ğŸ”„ ${imageName}: é™çº§åURL - ${url.substring(0, 60)}...\n`;
                } catch (error) {
                    log.innerHTML += `âŒ ${imageName}: é™çº§å¤„ç†å¤±è´¥ - ${error.message}\n`;
                }
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            cloudImageManager.log('æµ‹è¯•å¼€å§‹', 'å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•');
            
            showDeviceInfo();
            
            await testCloudImages();
            await testPlaceholderImages();
            await testErrorHandling();
            
            cloudImageManager.log('æµ‹è¯•å®Œæˆ', 'æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>